trigger:
- master
pool:
  name: test
steps:
- checkout: self
  clean: true
  fetchDepth: 1

# Cache Composer dependencies
- task: Cache@2
  inputs:
    key: 'composer | "$(Agent.OS)" | composer.lock'
    path: vendor
  displayName: Cache vendor

- script: composer install --no-interaction --no-progress --prefer-dist
  displayName: Install dependencies
  condition: ne(variables['CacheRestored'], 'true')

- script: composer audit || true
  displayName: Security scan

- script: |
    pip3 install --user semgrep 2>/dev/null || true
    ~/.local/bin/semgrep --config=auto || true
  displayName: SAST

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: .
    archiveFile: $(Build.ArtifactStagingDirectory)/akaunting.zip
    
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)
    ArtifactName: akaunting-build
