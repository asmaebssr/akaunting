trigger:
  - master

pool:
  name: test
  clean: all  # <-- clean workspace before each run

variables:
  phpVersion: '8.3'
  appName: 'akaunting-app'

# ============================================
# STAGE 1: BUILD & UNIT TESTS
# ============================================
stages:
  - build
  - security
  - containerize
  - deploy

build:
  stage: build
  displayName: 'Build & Unit Tests'
  jobs:
  - job: BuildJob
    displayName: 'Build Application'
    steps:
      # Checkout
      - checkout: self
        clean: true
        fetchDepth: 1
        displayName: 'Checkout code'

      # System update & PHP setup
      - script: |
          sudo apt-get update
          sudo apt-get install -y php php-cli php-mbstring php-xml php-curl php-zip \
                                   php-bcmath php-intl php-gd php-mysql unzip curl git python3-pip
          php -v
        displayName: 'Install PHP & Dependencies'

      # Composer installation
      - script: |
          curl -sS https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer
          composer --version
        displayName: 'Install Composer'

      # Cache composer dependencies
      - task: Cache@2
        inputs:
          key: 'composer | "$(Agent.OS)" | composer.lock'
          path: vendor
        displayName: 'Cache Composer Packages'

      # Install project dependencies
      - script: composer install --no-interaction --no-progress --prefer-dist
        displayName: 'Install PHP Dependencies'

      # Unit tests
      - script: |
          cp .env.example .env
          php artisan key:generate
          vendor/bin/phpunit --log-junit test-results.xml || true
        displayName: 'Run Unit Tests'

      # Publish test results
      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: 'test-results.xml'
          failTaskOnFailedTests: false
        displayName: 'Publish Test Results'
        condition: always()

      # Archive application files (minimal, no Docker image)
      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'app'   # only app folder, not entire repo
          includeRootFolder: false
          archiveType: 'tar'
          archiveFile: '$(Build.ArtifactStagingDirectory)/app.tar.gz'
          replaceExistingArchive: true
        displayName: 'Archive Application Files'

      # Publish application artifact
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'app-files'
        displayName: 'Publish Application Files'

# ============================================
# STAGE 2: SECURITY SCANS
# ============================================
security:
  stage: security
  displayName: 'Security Scanning'
  dependsOn: Build
  jobs:
  - job: SecurityJob
    displayName: 'Run Security Scans'
    steps:
      - checkout: self

      # Install tools
      - script: |
          sudo apt-get update
          sudo apt-get install -y php php-cli php-mbstring php-xml php-bcmath php-intl php-gd curl git python3-pip
          curl -sS https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer
        displayName: 'Setup Environment'

      # Restore dependencies
      - task: Cache@2
        inputs:
          key: 'composer | "$(Agent.OS)" | composer.lock'
          path: vendor
      - script: composer install --no-interaction --no-progress
        displayName: 'Restore Dependencies'

      # 1ï¸âƒ£ SAST - Static Code Analysis
      - script: |
          pip3 install semgrep
          semgrep --config=auto --json --output=semgrep-results.json || true
          cat semgrep-results.json
        displayName: 'ðŸ” SAST - Static Code Analysis'
        continueOnError: true

      # 2ï¸âƒ£ SCA - Dependency Check
      - script: |
          composer audit --format=json > composer-audit.json || true
          cat composer-audit.json
        displayName: 'ðŸ” SCA - Dependency Vulnerability Scan'
        continueOnError: true

      # 3ï¸âƒ£ Secret scanning
      - script: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json --no-git || true
          cat gitleaks-report.json
        displayName: 'ðŸ” Secret Scanning'
        continueOnError: true

      # 4ï¸âƒ£ Code Quality
      - script: |
          composer require --dev squizlabs/php_codesniffer
          vendor/bin/phpcs --standard=PSR12 --report=json --report-file=phpcs-report.json app/ || true
        displayName: 'ðŸ” Code Quality Analysis'
        continueOnError: true

      # Publish security reports
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '.'
          ArtifactName: 'security-reports'
        displayName: 'Publish Security Reports'

# ============================================
# STAGE 3: DOCKER BUILD & CONTAINER SCAN
# ============================================
containerize:
  stage: containerize
  displayName: 'Docker Build & Scan'
  dependsOn: Security
  jobs:
  - job: DockerJob
    displayName: 'Docker Build & Scan'
    steps:
      - checkout: self

      # Build Docker image
      - script: |
          cat > Dockerfile << 'EOF'
          FROM php:8.3-apache
          RUN apt-get update && apt-get install -y \
              libpng-dev libjpeg-dev libfreetype6-dev libzip-dev libicu-dev libonig-dev \
              git unzip curl \
              && docker-php-ext-configure gd --with-freetype --with-jpeg \
              && docker-php-ext-install -j$(nproc) bcmath gd intl mbstring pdo pdo_mysql zip
          RUN a2enmod rewrite
          COPY . /var/www/html
          WORKDIR /var/www/html
          COPY --from=composer:latest /usr/bin/composer /usr/bin/composer
          RUN composer install --no-dev --optimize-autoloader
          RUN chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
          EXPOSE 80
          CMD ["apache2-foreground"]
          EOF
          docker build -t $(appName):$(Build.BuildId) .
          docker tag $(appName):$(Build.BuildId) $(appName):latest
        displayName: 'Build Docker Image'

      # Scan Docker image
      - script: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.0_Linux-64bit.deb
          trivy image --format json --output trivy-report.json $(appName):$(Build.BuildId) || true
          trivy image $(appName):$(Build.BuildId)
        displayName: 'ðŸ” Container Security Scan'
        continueOnError: true

      # Publish Trivy report
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'trivy-report.json'
          ArtifactName: 'container-security-report'
        displayName: 'Publish Trivy Report'

# ============================================
# STAGE 4: DEPLOY TO AZURE WEB APP
# ============================================
deploy:
  stage: deploy
  displayName: 'Deploy to Azure'
  dependsOn: containerize
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - deployment: DeployToAzure
    displayName: 'Deploy to Azure Web App'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
            - download: current
              artifact: docker-image
            - download: current
              artifact: app-files
            # Deploy using Azure CLI
            - task: AzureCLI@2
              inputs:
                azureSubscription: 'azure-akaunting-connection'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  RESOURCE_GROUP="akaunting-rg"
                  APP_NAME="akaunting-webapp-$(Build.BuildId)"
                  LOCATION="eastus"
                  # Create App Service Plan
                  az appservice plan create \
                    --name "${APP_NAME}-plan" \
                    --resource-group $RESOURCE_GROUP \
                    --location $LOCATION \
                    --is-linux \
                    --sku F1 || true
                  # Create Web App
                  az webapp create \
                    --resource-group $RESOURCE_GROUP \
                    --plan "${APP_NAME}-plan" \
                    --name $APP_NAME \
                    --runtime "PHP:8.3"
                  # Configure app settings
                  az webapp config appsettings set \
                    --resource-group $RESOURCE_GROUP \
                    --name $APP_NAME \
                    --settings APP_ENV=production APP_DEBUG=false WEBSITES_ENABLE_APP_SERVICE_STORAGE=true
                  # Deploy app files
                  cd $(Pipeline.Workspace)/app-files
                  tar -xzf app.tar.gz -C /tmp/app-deploy
                  cd /tmp/app-deploy
                  zip -r deploy.zip .
                  az webapp deployment source config-zip \
                    --resource-group $RESOURCE_GROUP \
                    --name $APP_NAME \
                    --src deploy.zip
                  # Get URL
                  APP_URL=$(az webapp show \
                    --resource-group $RESOURCE_GROUP \
                    --name $APP_NAME \
                    --query defaultHostName -o tsv)
                  echo "âœ… Application deployed successfully! Access at: https://$APP_URL"
              displayName: 'Deploy to Azure Web App'
