trigger:
  - master

pool:
  name: test
  clean: all

variables:
  phpVersion: '8.3'
  appName: 'akaunting-app'

stages:
# =====================================================
# STAGE 1: BUILD & UNIT TESTS
# =====================================================
- stage: build
  displayName: 'Build & Unit Tests'
  jobs:
  - job: BuildJob
    displayName: 'Build Application'
    steps:
      - checkout: self
        clean: true
        fetchDepth: 1
        displayName: 'Checkout Source Code'

      - script: |
          sudo apt-get update
          sudo apt-get install -y \
            php php-cli php-mbstring php-xml php-curl php-zip \
            php-bcmath php-intl php-gd php-mysql \
            unzip curl git python3 python3-venv
          php -v
        displayName: 'Install PHP & System Dependencies'

      - script: |
          curl -sS https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer
          composer --version
        displayName: 'Install Composer'

      - task: Cache@2
        inputs:
          key: 'composer | "$(Agent.OS)" | composer.lock'
          path: vendor
        displayName: 'Cache Composer Dependencies'

      - script: composer install --no-interaction --no-progress --prefer-dist
        displayName: 'Install Dependencies'

      - script: |
          cp .env.example .env
          php artisan key:generate
          vendor/bin/phpunit --log-junit test-results.xml || true
        displayName: 'Run Unit Tests'

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: 'test-results.xml'
          failTaskOnFailedTests: false
        displayName: 'Publish Unit Test Results'
        condition: always()

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'app'
          includeRootFolder: false
          archiveType: 'tar'
          archiveFile: '$(Build.ArtifactStagingDirectory)/app.tar.gz'
          replaceExistingArchive: true
        displayName: 'Archive Application'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/app.tar.gz'
          ArtifactName: 'app-files'
        displayName: 'Publish Application Artifact'

# =====================================================
# STAGE 2: SECURITY SCANS
# =====================================================
- stage: security
  displayName: 'Security Scanning'
  dependsOn: build
  jobs:
  - job: SecurityJob
    displayName: 'Application Security Analysis'
    steps:
      - checkout: self

      - script: |
          sudo apt-get update
          sudo apt-get install -y \
            php php-cli php-mbstring php-xml php-bcmath php-intl php-gd \
            curl git python3 python3-venv
        displayName: 'Prepare Environment'

      - task: Cache@2
        inputs:
          key: 'composer | "$(Agent.OS)" | composer.lock'
          path: vendor

      - script: composer install --no-interaction --no-progress
        displayName: 'Restore Dependencies'

      # SAST – Semgrep
      - script: |
          python3 -m venv semgrep-venv
          source semgrep-venv/bin/activate
          pip install --upgrade pip
          pip install semgrep
          semgrep scan --config=auto --json --output=semgrep.json || true
        displayName: 'SAST – Semgrep'

      # SCA – Composer Audit
      - script: |
          composer audit --format=json > composer-audit.json || true
        displayName: 'SCA – Composer Audit'

      # Secret Scanning – Gitleaks
      - script: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          ./gitleaks detect \
            --source . \
            --report-format json \
            --report-path gitleaks.json \
            --no-git || true
        displayName: 'Secret Scanning – Gitleaks'

      # Code Quality – PHP_CodeSniffer
      - script: |
          composer require --dev squizlabs/php_codesniffer
          vendor/bin/phpcs \
            --standard=PSR12 \
            --report=json \
            --report-file=phpcs.json \
            app/ || true
        displayName: 'Code Quality – PHPCS'

      # Collect & Archive Security Reports
      - script: |
          mkdir security-reports
          mv semgrep.json security-reports/ || true
          mv composer-audit.json security-reports/ || true
          mv gitleaks.json security-reports/ || true
          mv phpcs.json security-reports/ || true
        displayName: 'Collect Security Reports'

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'security-reports'
          includeRootFolder: false
          archiveType: zip
          archiveFile: '$(Build.ArtifactStagingDirectory)/security-reports.zip'
          replaceExistingArchive: true
        displayName: 'Archive Security Reports'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/security-reports.zip'
          ArtifactName: 'security-reports'
        displayName: 'Publish Security Reports'

# =====================================================
# STAGE 3: DOCKER BUILD & CONTAINER SCAN
# =====================================================
- stage: containerize
  displayName: 'Docker Build & Container Scan'
  dependsOn: security
  jobs:
  - job: DockerJob
    displayName: 'Docker Build & Scan'
    steps:
      - checkout: self

      - script: |
          docker build -t $(appName):$(Build.BuildId) .
          docker tag $(appName):$(Build.BuildId) $(appName):latest
        displayName: 'Build Docker Image'

      - script: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.48.0_Linux-64bit.deb
          trivy image --format json --output trivy.json $(appName):$(Build.BuildId) || true
        displayName: 'Container Scan – Trivy'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'trivy.json'
          ArtifactName: 'container-security-report'
        displayName: 'Publish Container Report'

# =====================================================
# STAGE 4: DEPLOY TO AZURE
# =====================================================
- stage: deploy
  displayName: 'Deploy to Azure'
  dependsOn: containerize
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
  - deployment: DeployToAzure
    displayName: 'Azure Web App Deployment'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
            - download: current
              artifact: app-files

            - task: AzureCLI@2
              inputs:
                azureSubscription: 'azure-akaunting-connection'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  RESOURCE_GROUP="akaunting-rg"
                  APP_NAME="akaunting-webapp-$(Build.BuildId)"
                  LOCATION="eastus"

                  az appservice plan create \
                    --name "${APP_NAME}-plan" \
                    --resource-group $RESOURCE_GROUP \
                    --location $LOCATION \
                    --is-linux \
                    --sku F1 || true

                  az webapp create \
                    --resource-group $RESOURCE_GROUP \
                    --plan "${APP_NAME}-plan" \
                    --name $APP_NAME \
                    --runtime "PHP:8.3"

                  az webapp config appsettings set \
                    --resource-group $RESOURCE_GROUP \
                    --name $APP_NAME \
                    --settings APP_ENV=production APP_DEBUG=false

                  mkdir -p /tmp/app-deploy
                  tar -xzf $(Pipeline.Workspace)/app-files/app.tar.gz -C /tmp/app-deploy
                  cd /tmp/app-deploy
                  zip -r deploy.zip .
                  az webapp deployment source config-zip \
                    --resource-group $RESOURCE_GROUP \
                    --name $APP_NAME \
                    --src deploy.zip
